trigger: none

pr:
- dev

pool:
  vmImage: 'ubuntu-18.04'

jobs:
  - job: CreateResourceGroups
    steps:
      - bash: |
          echo "##vso[task.setvariable variable=resource_group;isOutput=true]ansibletest-$(uuidgen)"
          echo "##vso[task.setvariable variable=resource_group_secondary;isOutput=true]ansibletest2-$(uuidgen)"
        name: setvar
      - bash: |
          echo "Generate test resource group $(setvar.resource_group), $(setvar.resource_group_secondary)"
      - task: AzureCLI@2
        inputs:
          azureSubscription: '$(SUBSCRIPTION_FULL_NAME)'
          scriptType: 'bash'
          scriptLocation: 'inlineScript'
          inlineScript: |
              az group create -l eastus -n $(setvar.resource_group)
              az group create -l eastus -n $(setvar.resource_group_secondary)

  - job: RunTests
    dependsOn: CreateResourceGroups 
    variables:
      TEST_RESOURCE_GROUP: $[ dependencies.CreateResourceGroups.outputs['setvar.resource_group'] ]
      TEST_RESOURCE_GROUP_SECONDARY: $[ dependencies.CreateResourceGroups.outputs['setvar.resource_group_secondary'] ]
    strategy:
      matrix:
        Python3_sanity:
          python.version: '3.6'
          test.key: 'sanity'
        Python3_1:
          python.version: '3.6'
          test.key: '1'
        Python3_2:
          python.version: '3.6'
          test.key: '2'
        Python3_3:
          python.version: '3.6'
          test.key: '3'
        Python3_4:
          python.version: '3.6'
          test.key: '4'
        Python3_5:
          python.version: '3.6'
          test.key: '5'
        Python3_6:
          python.version: '3.6'
          test.key: '6'
        Python3.6:
          python.version: '3.6'
          test.key: '7'
        Python3_9:
          python.version: '3.6'
          test.key: '9'
        Python3_10:
          python.version: '3.6'
          test.key: '10'
        Python3_11:
          python.version: '3.6'
          test.key: '11'
        Python3_12:
          python.version: '3.6'
          test.key: '12'
        Python3_13:
          python.version: '3.6'
          test.key: '13'
        Python3_14:
          python.version: '3.6'
          test.key: '14'

    steps:
    - task: UsePythonVersion@0
      displayName: 'Use Python $(python.version)'
      inputs:
        versionSpec: '$(python.version)'

    - script: tests/utils/ado/ado.sh $(test.key)
      env:
        SHIPPABLE_BUILD_DIR: $(Build.Repository.LocalPath)
        AZURE_CLIENT_ID: $(AZURE_CLIENT_ID)
        AZURE_SECRET: $(AZURE_SECRET)
        AZURE_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)
        AZURE_TENANT: $(AZURE_TENANT)
        RESOURCE_GROUP: $(TEST_RESOURCE_GROUP)
        RESOURCE_GROUP_SECONDARY: $(TEST_RESOURCE_GROUP_SECONDARY)
      displayName: 'Running Tests'

  - job: CleanupResourceGroups
    dependsOn: 
      - CreateResourceGroups
      - RunTests
    condition: always()
    variables:
      TEST_RESOURCE_GROUP: $[ dependencies.CreateResourceGroups.outputs['setvar.resource_group'] ]
      TEST_RESOURCE_GROUP_SECONDARY: $[ dependencies.CreateResourceGroups.outputs['setvar.resource_group_secondary'] ]
    steps:
      - task: AzureCLI@2
        inputs:
          azureSubscription: '$(SUBSCRIPTION_FULL_NAME)'
          scriptType: 'bash'
          scriptLocation: 'inlineScript'
          inlineScript: |
              az group delete -n $(TEST_RESOURCE_GROUP) --yes --no-wait
              az group delete -n $(TEST_RESOURCE_GROUP_SECONDARY) --yes --no-wait
