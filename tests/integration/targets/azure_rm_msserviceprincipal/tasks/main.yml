- set_fact:
    rpfx: "{{ resource_group | hash('md5') | truncate(7, True, '') }}{{ 1000 | random }}"

- name: Create microsoft graph service principal
  azure_rm_msserviceprincipal:
    name: "{{ rpfx }}"
    sign_in_audience: AzureADandPersonalMicrosoftAccount
    public_client:
      redirect_uris:
        - https://localhost
    spa:
      redirect_uris:
        - https://localhost1
    web:
      redirect_uris:
        - https://localhost2
  register: create_output
    
- assert:
    that:
      - create_output.changed
    
- name: get microsoft graph service principal info by object_id
  azure_rm_msserviceprincipal_info:
    object_id: "{{ create_output.state.object_id }}"
  register: output
    
- assert:
    that:
      - output.service_principals[0].app_display_name == "{{ rpfx }}"
      - output.service_principals[0].sign_in_audience == "AzureADandPersonalMicrosoftAccount"
    
- name: Delete microsoft graph service principal
  azure_rm_msserviceprincipal:
    object_id: " {{create_output.state.object_id }}"
    state: absent
  register: output
    
- assert:
    that:
      - output.changed
