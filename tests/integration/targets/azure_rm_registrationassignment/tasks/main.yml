- name: set guid for registration assignment id
  set_fact:
    registration_definition_id: 2e853c04-ad29-4d0b-9f6b-e72c225d96c8

- name: Create a RegistrationAssignment ---check mode
  azure_rm_registrationassignment:
    scope: subscriptions//{{ subscription_id }}
    registration_assignment_id:  d96f61e7-af14-440c-be1b-8395c327ae29
    properties:
      registration_definition_id: /subscriptions/f64d4ee8-be94-457d-ba26-3fa6b6506cef/providers/Microsoft.ManagedServices/registrationDefinitions/d96f61e7-af14-440c-be1b-8395c327ae29
  register: output
  check_mode: yes

- assert:
    that:
      - output.changed 

- name: Create a RegistrationAssignment 
  azure_rm_registrationassignment:
    scope: subscriptions//{{ subscription_id }}
    registration_assignment_id:  d96f61e7-af14-440c-be1b-8395c327ae29
    properties:
      registration_definition_id: /subscriptions/f64d4ee8-be94-457d-ba26-3fa6b6506cef/providers/Microsoft.ManagedServices/registrationDefinitions/2e853c04-ad29-4d0b-9f6b-e72c225d96c6
    expand_registration_definition: true
  register: output

- assert:
    that:
      - output.changed

- name: Create a RegistrationAssignment -- idempotent
  azure_rm_registrationassignment:
    scope: subscriptions//{{ subscription_id }}
    registration_assignment_id:  d96f61e7-af14-440c-be1b-8395c327ae29
    properties:
      registration_definition_id: /subscriptions/f64d4ee8-be94-457d-ba26-3fa6b6506cef/providers/Microsoft.ManagedServices/registrationDefinitions/d96f61e7-af14-440c-be1b-8395c327ae29
    expand_registration_definition: true
  register: output

- assert:
    that:
      - not output.changed

- name: Update the RegistrationAssignment
  azure_rm_registrationassignment:
    scope: subscriptions//{{ subscription_id }}
    registration_assignment_id:  d96f61e7-af14-440c-be1b-8395c327ae29
    properties:
      registration_definition_id: /subscriptions/f64d4ee8-be94-457d-ba26-3fa6b6506cef/providers/Microsoft.ManagedServices/registrationDefinitions/d96f61e7-af14-440c-be1b-8395c327ae29
    expand_registration_definition: false
  register: output

- assert:
    that:
      - output.changed

- name: Get a RegistrationAssignment
  azure_rm_registrationassignment_info:
    scope: subscriptions//{{ subscription_id }}
    registration_assignment_id:  d96f61e7-af14-440c-be1b-8395c327ae29
    expand_registration_definition: true
  register: output

- assert:
    that:
      - output.registration_assignments[0].properties.provisioning_state == "Succeeded"

- name: Delete the RegistrationAssignment
  azure_rm_registrationassignment:
    scope: subscriptions//{{ subscription_id }}
    registration_assignment_id:  d96f61e7-af14-440c-be1b-8395c327ae29
    state: absent

